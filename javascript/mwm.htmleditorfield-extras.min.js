var _mwm=_mwm||{};_mwm.editors=_mwm.editors||{},_mwm.editorCount=_mwm.editorCount||0,_mwm.editorReset=50,function(t){t.entwine("ss",function(t){t("textarea.htmleditor").entwine({onadd:function(){var t=tinyMCE.get(this.attr("id"));t||this._super()},redraw:function(){var e=this,n=e.attr("id"),i=n+"--"+window.location.pathname.replace(/\W/g,"");if(!n)return this._super(),void 0;var r=ssTinyMceConfig,a=_mwm.editors.hasOwnProperty(i)?_mwm.editors[i]:t.extend({},ssTinyMceConfig);if("undefined"!=typeof a&&!a.hasOwnProperty("mwm")){a.mwm=!0,e.data("tinymceContentCss")&&(a.old_content_css=ssTinyMceConfig.content_css,a.content_css=e.data("tinymceContentCss")),e.hasClass("limited-with-links")&&a.hasOwnProperty("plugins")&&-1!==a.plugins.indexOf("-ssbuttons")&&a.hasOwnProperty("theme_advanced_buttons1")&&-1===a.theme_advanced_buttons1.indexOf("sslink")&&(a.theme_advanced_buttons1=a.theme_advanced_buttons1+",sslink,unlink"),e.data("tinymceClasses")&&(a.body_class=a.hasOwnProperty("body_class")?a.body_class+" "+e.data("tinymceClasses"):e.data("tinymceClasses"));var s=a.hasOwnProperty("setup")?a.setup:null;a.setup=function(n){var i=0,r=0,o=0,d=t("#"+n.editorId),l="";if(d.attr("maxlength")){var m=d.attr("maxlength"),c=d.data("tinymceMaxlengthIndicator"),u=[];c&&(l=ss.i18n._t("HTMLEditorField.THERE_ARE","There are")+" "+m+" "+ss.i18n._t("HTMLEditorField.CHARACTERS_LEFT","characters left"),c&&("string"==typeof c||c instanceof String)&&(u=t(c)),u.length&&(u.text(l),0>=m?u.addClass("error"):u.removeClass("error"))),n.onKeyUp.add(function(t){r=e.getTextCountFromEditor(t),i=m-r,0>i&&(i=0),c&&(l=ss.i18n._t("HTMLEditorField.THERE_ARE","There are")+" "+i+" "+ss.i18n._t("HTMLEditorField.CHARACTERS_LEFT","characters left"),u.length?(u.text(l),0>=i?u.addClass("error"):u.removeClass("error")):0>=i||o!=r&&statusMessage(l)),setTimeout(function(){o=r},0)}),n.onChange.add(function(t){r=e.getTextCountFromEditor(t),i=m-r,0>i&&(i=0),c&&(l=ss.i18n._t("HTMLEditorField.THERE_ARE","There are")+" "+i+" "+ss.i18n._t("HTMLEditorField.CHARACTERS_LEFT","characters left"),u.length?(u.text(l),0>=i?u.addClass("error"):u.removeClass("error")):0>=i||o!=r&&statusMessage(l)),setTimeout(function(){o=r},0)}),n.onKeyDown.add(function(t,n){i||(r=e.getTextCountFromEditor(t),i=m-r),0>=i&&8!=n.keyCode&&46!=n.keyCode&&(tinymce.dom.Event.cancel(n),errorMessage(ss.i18n.sprintf(ss.i18n._t("HTMLEditorField.MAX_CHARACTERS","This field can only contain %s characters"),m)))})}s&&s(n);var h=a.hasOwnProperty("editor_selector")?a.editor_selector:"";n.onPostRender.add(function(n){var i=t("#"+n.editorId).siblings("#"+n.editorContainer);setTimeout(function(){n.container?t(n.container).addClass(e.attr("class").replace(h,"")):i.length&&i.addClass(e.attr("class").replace(h,""))},10)})},_mwm.editorCount++,_mwm.editors[i]=a,_mwm.editorCount>_mwm.editorReset&&(_mwm.editors={})}ssTinyMceConfig=a,this._super(),ssTinyMceConfig=r},getTextCountFromEditor:function(t){t||(t=this.getEditor());var e=t.getContent().replace(/<[^>]*>/g,"").replace(/\s+/g," ");return e=e.replace(/^\s\s*/,"").replace(/\s\s*$/,""),e?e.length:0}}),t("form.htmleditorfield-linkform").entwine({getEditorField:function(){return t("#"+this.getEditor().getInstance().editorId)},googleLinkTracking:function(){var t=this.getEditorField();return t.length&&t.hasClass("google-link-tracking")},emailFriendly:function(){var t=this.getEditorField();return t.length&&t.hasClass("email-friendly")},redraw:function(){this._super();var t=this.find(":input[name=LinkType]:checked").val(),e=this.emailFriendly();this.googleLinkTracking()&&this.find(".google-analytics-tracking").show().find(".field").show(),e||"internal"!==t&&"external"!==t||!this.find('.field[id$="TargetModal"]').length||this.find('.field[id$="TargetModal"]').show()},getLinkAttributes:function(){var e=this._super(),n=this.find(":input[name=utm_source]");if(this.find(":input[name=TargetModal]").is(":checked")&&(e["data-toggle"]="modal"),e.hasOwnProperty("href")&&0!=e.href.indexOf("mailto:")&&n.length&&n.val()){var i=this.find(":input[name=utm_medium]").val(),r=this.find(":input[name=utm_term]").val(),a=this.find(":input[name=utm_content]").val(),s=this.find(":input[name=utm_campaign]").val(),o={utm_source:encodeURIComponent(n.val())};o.utm_medium=i?i:encodeURIComponent("none"),r&&(o.utm_term=encodeURIComponent(r)),a&&(o.utm_content=encodeURIComponent(a)),s&&(o.utm_campaign=encodeURIComponent(s)),e.href+=-1!=e.href.indexOf("?")?"&amp;"+t.param(o).replace("&","&amp;"):"?"+t.param(o)}return e},getCurrentLink:function(){var e=this._super(),n=this.googleLinkTracking();if(null!==e&&!n)return e;var i=this.getSelection(),r=null;if(i.length&&(r=i.is("a")?i:i=i.parents("a:first")),r&&r.length&&this.modifySelection(function(t){t.selectNode(r[0])}),r.attr("href")||(r=null),r&&r.hasData("toggle")&&"modal"==r.data("toggle")&&(e.TargetModal=!0),n)if(null!==e){var a=r.attr("href").replace("&amp;","&"),s=-1!=a.indexOf("?")?a.substring(a.indexOf("?")+1,a.length):"";if(s){var o,d=this.deparam(s);d&&!t.isEmptyObject(d)&&t.each(d,function(t,n){0==t.indexOf("utm_")&&(o=t+"="+n,e[t]=decodeURIComponent(n),a=a.replace(o,"").replace(/[\?|&]+$/,""))}),a.match(/^\[sitetree_link(?:\s*|%20|,)?id=([0-9]+)\]?(#.*)?$/i)?(e.LinkType="internal",e.internal=RegExp.$1,e.Anchor=RegExp.$2?RegExp.$2.substr(1):"",e.hasOwnProperty("external")&&delete e.external):e.external=a}}else{var l=this.getEditorField(),m=l.data("utmSource"),c=l.data("utmMedium"),u=l.data("utmTerm"),h=l.data("utmContent"),g=l.data("utmCampaign");m&&(e.utm_source=0==m.indexOf("#")&&t(m).length?t(m).is(":input")?t(m).val():t(m).text():m),c&&(e.utm_medium=0==c.indexOf("#")&&t(c).length?t(c).is(":input")?t(c).val():t(c).text():c),u&&(e.utm_term=0==u.indexOf("#")&&t(u).length?t(u).is(":input")?t(u).val():t(u).text():u),h&&(e.utm_content=0==h.indexOf("#")&&t(h).length?t(h).is(":input")?t(h).val():t(h).text():h),g&&(e.utm_campaign=0==g.indexOf("#")&&t(g).length?t(g).is(":input")?t(g).val():t(g).text():g)}return e},deparam:function(t){t=t.substring(t.indexOf("?")+1).split("&");var e,n,i={},r=decodeURIComponent;for(n=t.length;n>0;)e=t[--n].split("="),i[r(e[0])]=r(e[1]);return i}})})}(jQuery);